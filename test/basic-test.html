<!doctype html>
<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <script>
    window.__env = 'test';
    </script>
    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../iron-test-helpers/test-helpers.js"></script>
    <script src="../../iron-test-helpers/mock-interactions.js"></script>
    <script src="../../chance/dist/chance.min.js"></script>
    <script src="exchange-server-helper.js"></script>
    <link rel="import" href="../exchange-search-panel.html">
  </head>
  <body>

    <test-fixture id="basic">
      <template>
        <exchange-search-panel></exchange-search-panel>
      </template>
    </test-fixture>

    <test-fixture id="opened">
      <template>
        <exchange-search-panel attr-for-opened="opened"></exchange-search-panel>
      </template>
    </test-fixture>

    <test-fixture id="auth">
      <template>
        <exchange-search-panel allow-auth exchange-redirect-uri="https://domain.com" exchange-client-id="test1234" force-oauth-events></exchange-search-panel>
      </template>
    </test-fixture>

    <script>
    /* global fixture, assert, ExchangeServer, TestHelpers, sinon */
    suite('basic with auto opened', function() {

      suiteSetup(function() {
        ExchangeServer.createServer();
      });

      suiteTeardown(function() {
        ExchangeServer.restore();
      });

      suite('basic when auto querying', function() {
        var element;
        setup(function() {
          element = fixture('basic');
          // element.addEventListener('auth-initialized-changed', function clb(e) {
          //   if (e.detail.value) {
          //     element.removeEventListener('auth-initialized-changed', clb);
          //     done();
          //   }
          // });
        });

        test('querying is true', function() {
          assert.isTrue(element.querying);
        });

        test('dataUnavailable is computed', function() {
          assert.isFalse(element.dataUnavailable);
        });

        test('hasItems is false', function() {
          assert.isFalse(element.hasItems);
        });

        test('query is empty string', function() {
          assert.equal(element.query, '');
        });

        test('noMoreResults is false by default', function() {
          assert.isFalse(element.noMoreResults);
        });

        test('List view is false by default', function() {
          assert.isFalse(element.listView);
        });

        test('queryParams is computed', function() {
          var p = element.queryParams;
          assert.typeOf(p, 'object');
          assert.equal(p.type, element.exchangeType, 'type is set');
          assert.equal(p.limit, element.exchangeLimit, 'limit is set');
          assert.equal(p.offset, element.exchangeOffset, 'offset is set');
          assert.isUndefined(p.search, 'search is undefined');
        });

        test('queryParams is computed with search', function() {
          element.query = 'test';
          var p = element.queryParams;
          assert.typeOf(p, 'object');
          assert.equal(p.type, element.exchangeType, 'type is set');
          assert.equal(p.limit, element.exchangeLimit, 'limit is set');
          assert.equal(p.offset, element.exchangeOffset, 'offset is set');
          assert.equal(p.search, element.query, 'search is set');
        });

        test('renderLoadMore is false', function() {
          assert.isFalse(element.renderLoadMore);
        });
      });

      suite('basic with data loaded', function() {
        var element;
        setup(function(done) {
          element = fixture('basic');
          element.addEventListener('querying-changed', function clb(e) {
            if (e.detail.value === false) {
              element.removeEventListener('querying-changed', clb);
              done();
            }
          });
        });

        test('querying is false', function() {
          assert.isFalse(element.querying);
        });

        test('dataUnavailable is computed', function() {
          assert.isFalse(element.dataUnavailable);
        });

        test('items is set', function() {
          assert.typeOf(element.items, 'array', 'items is an array');
          assert.lengthOf(element.items, 20, 'items contains one page of results');
        });

        test('exchangeOffset is moved by number of items on the list', function() {
          assert.equal(element.exchangeOffset, 20);
        });

        test('noMoreResults is not set', function() {
          assert.isFalse(element.noMoreResults);
        });

        test('renderLoadMore is true when not querying', function() {
          assert.isTrue(element.renderLoadMore);
        });

        test('_checkLoad() will not call query function', function() {
          element._checkLoad(true);
          assert.isFalse(element.querying);
        });
      });

      suite('reset()', function() {
        var element;
        setup(function() {
          element = fixture('basic');
          element.items = [{name: 'test'}];
          element.exchangeOffset = 20;
          element.noMoreResults = true;
          element.querying = true;
          element.reset();
        });

        test('Resets the items', function() {
          assert.typeOf(element.items, 'array', 'items is an array');
          assert.lengthOf(element.items, 0, 'items is empty');
        });

        test('Resets exchangeOffset', function() {
          assert.equal(element.exchangeOffset, 0);
        });

        test('Resets noMoreResults', function() {
          assert.isFalse(element.noMoreResults);
        });

        test('Resets querying', function() {
          assert.isFalse(element.querying);
        });
      });

      suite('_enableList()', function() {
        var element;
        setup(function(done) {
          element = fixture('basic');
          element.addEventListener('querying-changed', function clb(e) {
            if (e.detail.value === false) {
              element.removeEventListener('querying-changed', clb);
              TestHelpers.forceXIfStamp(element);
              done();
            }
          });
        });

        test('Sets listView to true', function() {
          element._enableList();
          assert.isTrue(element.listView);
        });

        test('Renders list items', function() {
          element._enableList();
          TestHelpers.forceXIfStamp(element);
          var item = element.$$('exchange-search-list-item');
          assert.isOk(item);
        });

        test('Keeps toggle button enabled', function() {
          element._enableList();
          var item = element.$$('[data-action="list-enable"]');
          assert.isTrue(item.active);
        });
      });

      suite('_enableGrid()', function() {
        var element;
        setup(function(done) {
          element = fixture('basic');
          element.listView = true;
          element.addEventListener('querying-changed', function clb(e) {
            if (e.detail.value === false) {
              element.removeEventListener('querying-changed', clb);
              TestHelpers.forceXIfStamp(element);
              done();
            }
          });
        });

        test('Sets listView to false', function() {
          element._enableGrid();
          assert.isFalse(element.listView);
        });

        test('Renders grid items', function() {
          element._enableGrid();
          TestHelpers.forceXIfStamp(element);
          var item = element.$$('exchange-search-grid-item');
          assert.isOk(item);
        });

        test('Keeps toggle button enabled', function() {
          element._enableGrid();
          var item = element.$$('[data-action="grid-enable"]');
          assert.isTrue(item.active);
        });
      });

      suite('updateSearch()', function() {
        var element;
        setup(function() {
          element = fixture('opened');
        });

        test('Calls reset function', function() {
          var stub = sinon.stub(element, 'reset');
          element.updateSearch();
          assert.isTrue(stub.called);
          stub.restore();
        });

        test('Calls query function', function() {
          var stub = sinon.stub(element, 'queryCurrent');
          element.updateSearch();
          assert.isTrue(stub.called);
          stub.restore();
        });
      });

      suite('_computeDataUnavailable()', function() {
        var element;
        setup(function() {
          element = fixture('opened');
        });

        test('Returns true when both arguments are falsy', function() {
          var result = element._computeDataUnavailable(false, false);
          assert.isTrue(result);
        });

        test('Returns false for any other combination', function() {
          var result = element._computeDataUnavailable(true, false);
          assert.isFalse(result);
          result = element._computeDataUnavailable(false, true);
          assert.isFalse(result);
          result = element._computeDataUnavailable(true, true);
          assert.isFalse(result);
        });
      });

      suite('queryCurrent()', function() {
        var element;
        setup(function() {
          element = fixture('opened');
        });

        test('Sets querying to true', function() {
          element.queryCurrent();
          assert.isTrue(element.querying);
        });

        test('Calls ajax element', function(done) {
          element._exchangeResponse = function() {
            done();
          };
          element.queryCurrent();
        });
      });

      suite('_exchangeResponse()', function() {
        var element;
        var emptyResponse;
        var dataResponse;
        setup(function() {
          element = fixture('opened');
          emptyResponse = {
            detail: {
              response: []
            }
          };
          dataResponse = {
            detail: {
              response: [
                ExchangeServer.createListObject(),
                ExchangeServer.createListObject(),
                ExchangeServer.createListObject(),
                ExchangeServer.createListObject()
              ]
            }
          };
        });

        test('Sets noMoreResults when no data', function() {
          element._exchangeResponse(emptyResponse);
          assert.isTrue(element.noMoreResults);
        });

        test('Sets querying to false when no data', function() {
          element._setQuerying(true);
          element._exchangeResponse(emptyResponse);
          assert.isFalse(element.querying);
        });

        test('Sets noMoreResults when data size is less than exchangeLimit', function() {
          element._exchangeResponse(dataResponse);
          assert.isTrue(element.noMoreResults);
        });

        test('Do not sets noMoreResults when within exchangeLimit', function() {
          element.exchangeLimit = 4;
          element._exchangeResponse(dataResponse);
          assert.isFalse(element.noMoreResults);
        });

        test('Sets items property', function() {
          element._exchangeResponse(dataResponse);
          assert.typeOf(element.items, 'array');
          assert.lengthOf(element.items, 4);
        });

        test('Sets exchangeOffset to size of array', function() {
          assert.equal(element.exchangeOffset, 0);
          element._exchangeResponse(dataResponse);
          assert.equal(element.exchangeOffset, 4);
          element._exchangeResponse(dataResponse);
          assert.equal(element.exchangeOffset, 8);
        });

        test('Sets querying to false', function() {
          element._setQuerying(true);
          element._exchangeResponse(dataResponse);
          assert.isFalse(element.querying);
        });
      });

      suite('_computeQueryParams()', function() {
        var element;
        setup(function() {
          element = fixture('opened');
        });

        test('Sets required properties', function() {
          var result = element._computeQueryParams('a', 'b', 'c');
          assert.equal(result.type, 'a');
          assert.equal(result.limit, 'b');
          assert.equal(result.offset, 'c');
          assert.isUndefined(result.search);
        });

        test('Sets search if not empty', function() {
          var result = element._computeQueryParams('a', 'b', 'c', 'd');
          assert.equal(result.search, 'd');
        });
      });

      suite('Authorization properties', function() {
        var element;
        setup(function() {
          element = fixture('auth');
        });

        test('accessToken is not set', function() {
          assert.isUndefined(element.accessToken);
        });

        test('Automatically asks for access token', function(done) {
          document.body.addEventListener('oauth2-token-requested', function clb(e) {
            document.body.removeEventListener('oauth2-token-requested', clb);
            let info = e.detail;
            assert.isFalse(info.interactive);
            done();
          });
        });

        test('Renders authorization button', function() {
          TestHelpers.forceXIfStamp(element);
          const button = element.$$('.auth-button');
          assert.ok(button, 'Button is in the DOM');
          const display = getComputedStyle(button).display;
          assert.notEqual(display, 'none');
        });

        test('Sets up auth headers', function() {
          element.accessToken = 'test';
          var headers = element.$.query.headers;
          assert.equal(headers.authorization, 'Bearer test');
        });
      });
    });
    </script>
  </body>
</html>
