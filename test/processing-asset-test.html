<!doctype html>
<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../iron-test-helpers/test-helpers.js"></script>
    <script src="../../iron-test-helpers/mock-interactions.js"></script>
    <script src="../../chance/dist/chance.min.js"></script>
    <script src="exchange-server-helper.js"></script>
    <link rel="import" href="../exchange-search-panel.html">
  </head>
  <body>
    <test-fixture id="basic">
      <template>
        <exchange-search-panel></exchange-search-panel>
      </template>
    </test-fixture>

    <script>
    /* global fixture, assert, ExchangeServer, TestHelpers */
    suite('Processing Exchange assets', function() {
      var blob;
      suiteSetup(function() {
        ExchangeServer.createServer();
        var data = 'data:application/zip;base64,UEsDBAoAAAAAALM5LEwAAAAAAAAAAAA';
        data += 'AAAAEABAAYXBpL1VYDACy0FhaodBYWvUBFABQSwMEFAAIAAgAtDksTAAAAAAAA';
        data += 'AAAAAAAAAwAEABhcGkvYXBpLnJhbWxVWAwAptBYWqTQWFr1ARQAK0ktLuECAFB';
        data += 'LBwjGNbk7BwAAAAUAAABQSwECFQMKAAAAAACzOSxMAAAAAAAAAAAAAAAABAAMA';
        data += 'AAAAAAAAABA7UEAAAAAYXBpL1VYCACy0FhaodBYWlBLAQIVAxQACAAIALQ5LEz';
        data += 'GNbk7BwAAAAUAAAAMAAwAAAAAAAAAAECkgTIAAABhcGkvYXBpLnJhbWxVWAgAp';
        data += 'tBYWqTQWFpQSwUGAAAAAAIAAgCEAAAAgwAAAAAA';
        var arr = data.split(',');
        // var mime = arr[0].match(/:(.*?);/)[1];
        var bstr = atob(arr[1]);
        var n = bstr.length;
        var u8arr = new Uint8Array(n);
        while (n--) {
          u8arr[n] = bstr.charCodeAt(n);
        }
        blob = new Blob([u8arr], {type: 'application/binary'});
      });

      suiteTeardown(function() {
        ExchangeServer.restore();
      });

      suite('_downloadItem()', function() {
        var element;
        var argument;
        setup(function(done) {
          element = fixture('basic');
          element._assetDownloaded = function() {};
          element.addEventListener('querying-changed', function clb(e) {
            if (e.detail.value === false) {
              element.removeEventListener('querying-changed', clb);
              TestHelpers.forceXIfStamp(element);
              var item = element.$$('exchange-search-grid-item');
              var model = element.$$('#list').modelForElement(item);
              argument = {
                model: model
              };
              done();
            }
          });
        });

        test('Sets downloadingAsset to true', function() {
          element._downloadItem(argument);
          assert.isTrue(element.downloadingAsset);
        });

        test('Sets an URL on the download ajax', function() {
          element._downloadItem(argument);
          assert.equal(element.$.download.url, 'http://fake-download-asset.com');
        });
      });

      suite('_assetDownloaded()', function() {
        var element;
        var response;
        setup(function() {
          element = fixture('basic');
          element.downloadingAsset = true;
          response = {
            detail: {
              response: blob
            }
          };
        });

        test('Sets downloadingAsset to false', function() {
          element._assetDownloaded(response);
          assert.isFalse(element.downloadingAsset);
        });

        test('Sets readingFile to true', function() {
          element._assetDownloaded(response);
          assert.isFalse(element.downloadingAsset);
        });

        test('Sets web-unzip element properties', function() {
          element._assetDownloaded(response);
          assert.typeOf(element.$.unzip.file[0], 'blob');
          assert.equal(element.$.unzip.file[0].type, 'application/zip');
          assert.lengthOf(element.$.unzip.file, 1);
        });
      });
    });
    </script>

  </body>
</html>
