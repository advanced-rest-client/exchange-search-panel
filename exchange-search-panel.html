<!--
@license
Copyright 2016 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../paper-progress/paper-progress.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../arc-icons/arc-icons.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-input/paper-input-container.html">
<link rel="import" href="../iron-input/iron-input.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../anypoint-signin/anypoint-signin.html">
<link rel="import" href="exchange-search-grid-item.html">
<link rel="import" href="exchange-search-list-item.html">
<dom-module id="exchange-search-panel">
  <template>
    <style include="paper-item-shared-styles"></style>
    <style>
    :host {
      display: block;
      @apply --exchange-search-panel;

      --paper-rating-icon: {
        width: 20px;
        height: 20px;
      };
    }

    .header {
      @apply --layout-horizontal;
      @apply --layout-center;
      @apply --exchange-search-panel-header;
    }

    h2 {
      @apply --arc-font-headline;
      @apply --layout-flex;
    }

    [hidden] {
      display: none !important;
    }

    paper-progress {
      width: 100%;
      @apply --exchange-search-panel-loader;
    }

    paper-icon-button {
      border-radius: 50%;
      min-width: 40px;
      min-height: 40px;
    }

    paper-icon-button[active] {
      background-color: var(--exchange-search-panel-toggle-view-active-background-color, #00A1DF);
      color: var(--exchange-search-panel-toggle-view-active-color, #fff);
    }

    .error-toast {
      background-color: var(--warning-primary-color, #FF7043);
      color: var(--warning-contrast-color, #fff);
      @apply --error-toast;
    }

    .empty-info {
      font-size: 16px;
      @apply --empty-info;
    }

    .header-actions {
      @apply --layout-horizontal;
      @apply --layout-center;
    }

    .search-bar {
      @apply --layout-horizontal;
      @apply --layout-center;
    }

    .search-bar paper-input-container {
      @apply --layout-flex;
    }

    input[type="search"] {
      @apply --paper-input-container-shared-input-style;
    }

    .list {
      @apply --layout-horizontal;
      @apply --layout-wrap;
      @apply --exchange-search-panel-list;
    }

    .list[data-list] {
      @apply --layout-vertical;
    }

    exchange-search-grid-item {
      width: calc(var(--exchange-search-grid-item-computed-width, 25%) - 16px);
      margin: 8px;
    }

    .paper-item {
      cursor: pointer;
    }

    .action-button {
      @apply --action-button;
    }

    .action-button:hover {
      @apply --action-button-hover;
    }

    .load-more {
      @apply --layout-vertical;
      @apply --layout-center-center;
      margin-top: 20px;
    }

    .auth-button {
      margin-right: 8px;
    }

    .exchange-icon {
      margin-right: 8px;
    }

    .connecting-info {
      width: 320px;
      margin: 0 auto;
      @apply --arc-font-body1;
      text-align: center;
    }
    </style>
    <div class="header">
      <h2>Explore REST APIs</h2>
      <div class="header-actions">
        <template is="dom-if" if="[[anypointAuth]]">
          <anypoint-signin
            disabled$="[[!authInitialized]]"
            class="auth-button"
            redirect-uri="[[exchangeRedirectUri]]"
            client-id="[[exchangeClientId]]"
            signed-in="{{signedIn}}"
            access-token="{{accessToken}}"
            force-oauth-events="[[forceOauthEvents]]"
            width="wide"
            theme="dark"></anypoint-signin>
        </template>
        <paper-icon-button icon="arc:view-column" data-action="grid-enable" toggles active="[[!listView]]" on-tap="_enableGrid"></paper-icon-button>
        <paper-icon-button icon="arc:view-list" data-action="list-enable" toggles active="[[listView]]" on-tap="_enableList"></paper-icon-button>
      </div>
    </div>
    <div class="search-bar">
      <paper-input-container no-label-float>
        <label slot="label">Search for APIs in Anypoint Exchange</label>
        <iron-input slot="input">
          <input type="search" value="{{query::input}}" aria-label="Search for APIs in Anypoint Exchange" on-keydown="_searchKeydown" on-search="_searchHandler">
        </iron-input>
        <paper-icon-button title="Search" slot="suffix" icon="arc:search" on-tap="updateSearch"></paper-icon-button>
      </paper-input-container>
    </div>
    <template is="dom-if" if="[[!authInitialized]]">
      <div class="connecting-info">
        <p>Connecting to Anypoint Exchange</p>
        <paper-progress indeterminate></paper-progress>
      </div>
    </template>
    <template is="dom-if" if="[[querying]]">
      <paper-progress indeterminate></paper-progress>
    </template>
    <template is="dom-if" if="[[dataUnavailable]]">
      <p class="empty-info">Couldn't find requested API.</p>
    </template>
    <section class="list" data-list$="[[listView]]">
      <template is="dom-repeat" items="[[items]]" id="list">
        <template is="dom-if" if="[[!listView]]" restamp="true">
          <exchange-search-grid-item item="[[item]]" on-action-requested="_processItem" noink="[[noink]]" action-label="[[actionLabel]]"></exchange-search-grid-item>
        </template>
        <template is="dom-if" if="[[listView]]" restamp="true">
          <exchange-search-list-item item="[[item]]" on-action-requested="_processItem" noink="[[noink]]" action-label="[[actionLabel]]"></exchange-search-list-item>
        </template>
      </template>
    </section>
    <template is="dom-if" if="[[renderLoadMore]]">
      <div class="load-more">
        <paper-button raised class="action-button" on-tap="queryCurrent">Load more</paper-button>
      </div>
    </template>
    <iron-ajax id="query" url="[[exchangeSearchUri]]" handle-as="json" on-response="_exchangeResponse" debounce-duration="300" params="[[queryParams]]"  on-error="_exchangeResponseError"></iron-ajax>
    <paper-toast id="tokenExpired" text="You are logged out from the Exchange. Log in and try again." class="error-toast"></paper-toast>
    <paper-toast id="errorToast" class="error-toast"></paper-toast>
  </template>
  <script>
  /**
   * An element that displays an UI to search Anypoint Exchange for RAML (REST API) resources.
   *
   * It handles queries to the exchange server, displays list of results, handles user query
   * and informs the application when the user request asset details.
   *
   * It dispatches `process-exchange-asset-data` custom event when user requested
   * an action to be performed on the asset. Default label for an action is
   * `Download` but it can be changed by setting `actionLabel` property.
   *
   * ### Example
   *
   * ```html
   * <exchange-search-panel
   *  on-process-exchange-asset-data="_getAssetDetails"
   *  action-label="Details"></exchange-search-panel>
   * ```
   *
   * ### New in version 2.0
   *
   * - Renamed `allow-auth` attribute to `anypoint-auth`
   * - Added `columns` property to control grid view
   * - Updraded component to use Polymer 2.0
   *
   * ### Styling
   *
   * `<exchange-search-list-item>` provides the following custom properties and mixins for styling:
   *
   * Custom property | Description | Default
   * ----------------|-------------|----------
   * `--exchange-search-panel` | Mixin applied to the element | `{}`
   * `--exchange-search-panel-header` | Mixin applied to the header section with title and the list control buttons | `{}`
   * `--arc-font-headline` | Mixin applied to the title of the panel | `{}`
   * `--exchange-search-panel-toggle-view-active-background-color` | Background color of the lost control buttons | `#00A1DF`
   * `--exchange-search-panel-toggle-view-active-color` | Color of the lost control buttons | `#00A1DF`
   * `--warning-primary-color` | Main color of the warning messages | `#FF7043`
   * `--warning-contrast-color` | Contrast color for the warning color | `#fff`
   * `--error-toast` | Mixin applied to the error toast | `{}`
   * `--empty-info` | Mixin applied to the label rendered when no data is available. | `{}`
   * `--exchange-search-panel-list` | Mixin applied to the list element | `{}`
   * `--action-button` | Mixin applied to the "load more" button | `{}`
   * `--action-button-hover` | Mixin applied to the "load more" button when hovered | `{}`
   *
   * @customElement
   * @polymer
   * @demo demo/index.html Basic demo
   * @demo demo/scroll-target.html Using scroll target
   * @demo demo/shadow-scroll-target.html Using scroll target in shadow root
   * @memberof UiElements
   */
  class ExchangeSearchPanel extends Polymer.Element {
    static get is() {return 'exchange-search-panel';}
    static get properties() {
      return {
        /**
         * Saved items restored from the datastore.
         */
        items: Array,
        // True when the element is querying the database for the data.
        querying: {
          type: Boolean,
          readOnly: true,
          notify: true
        },
        // Computed value, true if the `items` property has values.
        hasItems: {
          type: Boolean,
          computed: '_computeHasItems(items.length)',
          notify: true
        },
        /**
         * Computed value. True if query ended and there's no results.
         */
        dataUnavailable: {
          type: Boolean,
          computed: '_computeDataUnavailable(hasItems, querying)'
        },
        // Search query for the list.
        query: String,
        // True if the Grid view is active
        listView: {
          type: Boolean,
          value: false
        },
        /**
         * If true, the element will not produce a ripple effect when interacted
         * with via the pointer.
         */
        noink: Boolean,
        /**
         * Rows offset in the Exchange's query.
         */
        exchangeOffset: {
          type: Number,
          value: 0
        },
        /**
         * Limit of the results in single query to the Exchange's API.
         */
        exchangeLimit: {
          type: Number,
          value: 20
        },
        /**
         * Exchange's asset type to search.
         */
        assetType: {
          type: String,
          value: 'rest-api',
          readOnly: true
        },
        /**
         * An URI to the endpoint with the search API.
         */
        exchangeSearchUri: {
          type: String,
          value: 'https://anypoint.mulesoft.com/exchange/api/v1/assets'
        },
        /**
         * Computed value of query parameters to be sent to Exchange's API
         */
        queryParams: {
          type: String,
          computed: '_computeQueryParams(assetType, exchangeLimit, exchangeOffset, query)'
        },
        /**
         * Scrolling target used to determine when authomatically download
         * next results.
         *
         * By default it is `document.documentElement`
         */
        scrollTarget: {
          type: Object,
          value: function() {
            return this._defaultScrollTarget;
          }
        },
        /**
         * Padding in pixels that will trigget query to the Exchange server
         * when the user scrolls the list.
         */
        listOffsetTrigger: {
          type: Number,
          value: 120
        },
        /**
         * Set when no more results are available for current offset - limit
         * values.
         */
        noMoreResults: {
          type: Boolean,
          notify: true,
          value: false
        },
        // Computed value, if true then it renders "load more" button below the list
        renderLoadMore: {
          type: Boolean,
          computed: '_computeRenderLoadMore(querying,noMoreResults)'
        },
        /**
         * If true it renders authorize button.
         * Note that the hosting application has to handle `oauth2-token-requested`
         * custom event.
         * See `oauth-authorization/oauth2-authorization.html` element for
         * more info.
         */
        anypointAuth: {
          type: Boolean,
          observer: '_anypointAuthChanged'
        },
        /**
         * The `redirect_uri` parameter of the OAuth2 request.
         * It must be set when `anypointAuth` is true or otherwise it will throw an
         * error when trying to request the toekn.
         */
        exchangeRedirectUri: String,
        /**
         * Registered within the exchange client id for OAuth2 calls.
         * It must be set when `anypointAuth` is true or otherwise it will throw an
         * error when trying to request the toekn.
         */
        exchangeClientId: String,
        /**
         * User access token to authorize the requests in the exchange
         */
        accessToken: {
          type: String,
          observer: '_accessTokenChenged'
        },
        // Computed value, true when access token is set.
        signedIn: Boolean,
        /**
         * Forces `anypoint-signin` element to use ARC's OAuth events.
         */
        forceOauthEvents: Boolean,
        /**
         * Flag indicating the authorization process has been initialized
         */
        authInitialized: {
          type: Boolean,
          notify: true,
          value: false,
          observer: '_authInitializedChanged'
        },
        /**
         * Label to display in main action button of a list item.
         * Default is `Download`.
         */
        actionLabel: String,
        /**
         * Number of columns to render in "grid" view.
         */
        columns: {
          type: Number,
          value: 4,
          observer: '_columnsChanged'
        },

        _isAttached: Boolean
      };
    }

    static get observers() {
      return [
        '_scrollTargetChanged(scrollTarget, _isAttached)'
      ];
    }

    constructor() {
      super();
      this._oauth2ErrorHandler = this._oauth2ErrorHandler.bind(this);
      this._oauth2SignedOut = this._oauth2SignedOut.bind(this);
      this._oauth2SignedIn = this._oauth2SignedIn.bind(this);
      this._onScroll = this._onScroll.bind(this);
    }

    connectedCallback() {
      super.connectedCallback();
      if (!this.anypointAuth) {
        this.authInitialized = true;
      }
      this._isAttached = true;
    }

    disconnectedCallback() {
      super.disconnectedCallback();
      this._isAttached = false;
    }

    _authInitializedChanged(state) {
      if (state) {
        this.updateSearch();
      }
    }

    /**
     * The default scroll target.
     *
     * @type {Element}
     */
    get _defaultScrollTarget() {
      return this._doc;
    }
    /**
     * Shortcut for the document element
     *
     * @type {Element}
     */
    get _doc() {
      return this.ownerDocument.documentElement;
    }

    _scrollTargetChanged(scrollTarget, isAttached) {
      if (this._oldScrollTarget) {
        const eventTarget = scrollTarget === this._doc ? window : scrollTarget;
        eventTarget.removeEventListener('scroll', this._onScroll);
        this._oldScrollTarget = undefined;
      }
      if (!isAttached) {
        return;
      }
      if (scrollTarget === 'document') {
        this.scrollTarget = this._doc;
      } else if (typeof scrollTarget === 'string') {
        let rootNode = this._findRootTarget();
        if (rootNode && rootNode.querySelector) {
          this.scrollTarget = rootNode.querySelector('#' + scrollTarget);
        } else {
          this.scrollTarget = undefined;
        }
      } else {
        this._oldScrollTarget = scrollTarget;
        if (scrollTarget) {
          const eventTarget = scrollTarget === this._doc ? window : scrollTarget;
          eventTarget.addEventListener('scroll', this._onScroll);
        }
      }
    }
    /**
     * @return {Element} First in path element that has shadow root or
     * ownerDocument of this component.
     */
    _findRootTarget() {
      let target = this.parentNode;
      const doc = this.ownerDocument;
      while (true) {
        if (!target) {
          return doc;
        }
        if (target && target.shadowRoot) {
          return target;
        } else if (target && target.host) {
          return target.host.shadowRoot;
        } else if (target === doc) {
          return target;
        }
        target = target.parentNode;
      }
    }

    /**
     * Computes value for the `hasItems` property.
     * @param {Number} length
     * @return {Boolean}
     */
    _computeHasItems(length) {
      return !!(length);
    }

    _computeRenderLoadMore(querying, noMoreResults) {
      return !querying && !noMoreResults;
    }
    /**
     * Resets element state so it re-enables querying.
     */
    reset() {
      this.set('items', []);
      this.set('exchangeOffset', 0);
      this.noMoreResults = false;
      this._setQuerying(false);
    }

    // Handler for grid view button click
    _enableGrid() {
      if (this.listView) {
        this.listView = false;
      }
      const toggle = this.shadowRoot.querySelector('[data-action="grid-enable"]');
      if (!toggle.active) {
        toggle.active = true;
      }
    }
    // Handler for list view button click
    _enableList() {
      if (!this.listView) {
        this.listView = true;
      }
      const toggle = this.shadowRoot.querySelector('[data-action="list-enable"]');
      if (!toggle.active) {
        toggle.active = true;
      }
    }
    /**
     * Resets current list of results and makes a query to the Exchange server.
     * It will use current value of search query (which might be empty) to
     * search for an asset.
     */
    updateSearch() {
      this.reset();
      this.queryCurrent();
    }

    _searchKeydown(e) {
      if (e.key === 'Enter' || e.which === 13 || e.keyCode === 13) {
        e.preventDefault();
        this.updateSearch();
      }
    }

    _searchHandler(e) {
      if (!e.target.value) {
        this.updateSearch();
      }
    }

    // Computes value for the `dataUnavailable` property.
    _computeDataUnavailable(hasItems, querying) {
      return !hasItems && !querying;
    }
    /**
     * Makes a query to the exchange server for more data.
     * It uses current `queryParams` to generate request.
     */
    queryCurrent() {
      this._setQuerying(true);
      this.$.query.generateRequest();
    }

    _exchangeResponse(e) {
      this.__retryTimeout = undefined;
      const data = e.detail.response;
      if (!data || !data.length) {
        this.noMoreResults = true;
        this._setQuerying(false);
        return;
      }
      if (data.length < this.exchangeLimit) {
        this.noMoreResults = true;
      }
      let items = this.items || [];
      items = items.concat(data);
      this.exchangeOffset += data.length;
      this.set('items', items);
      this._setQuerying(false);
    }

    _exchangeResponseError(e) {
      if (e.detail.request.status === 401 && this.signedIn) {
        // token expored
        this.accessToken = undefined;
        this.$.tokenExpired.opened = true;
        return;
      }
      let timeout = this.__retryTimeout || 1000;
      timeout *= 2;
      this.__retryTimeout = timeout;
      this.$.queryError.opened = true;
      setTimeout(() => this._setQuerying(false), timeout);
    }

    _computeQueryParams(type, limit, offset, query) {
      const params = {
        type: this._getAssetTypes(type),
        limit: limit,
        offset: offset
      };
      if (query) {
        params.search = query;
      }
      return params;
    }
    /**
     * Parses list of types to an array of types.
     * If the argument is array then it returns the same array.
     *
     * Note, this always returns array, even if the argument is empty.
     *
     * @param {String|Array} type Coma separated list of asset types.
     * Whitespaces are trimmed.
     * @return {Array<String>} List of asset types.
     */
    _getAssetTypes(type) {
      if (!type) {
        return [];
      }
      if (type instanceof Array) {
        return type;
      }
      if (type.indexOf(',') !== -1) {
        type = type.split(',').map(function(item) {
          return item.trim();
        });
      } else {
        type = [type];
      }
      return type;
    }
    /**
     * Reacts to `scrollTarget` scroll event. If the scroll Y position to the
     * bottom of the list is less than `listOffsetTrigger` then it triggers
     * query function.
     *
     * Note, if `noMoreResults` flag is set it will never query for more data.
     * You have to manually clear the property.
     */
    _onScroll() {
      if (this.querying || this.noMoreResults) {
        return;
      }
      let st = this._oldScrollTarget;
      const padding = st.scrollHeight - (st.clientHeight + st.scrollTop);
      if (padding <= this.listOffsetTrigger) {
        this.queryCurrent();
      }
    }
    /**
     * Dispatches `process-exchange-asset-data` when list item's
     * `on-main-action-requested` custom event is handled.
     *
     * @param {CustomEvent} e
     */
    _processItem(e) {
      const item = e.model.get('item');
      this.dispatchEvent(new CustomEvent('process-exchange-asset-data', {
        bubbles: true,
        composed: true,
        detail: item
      }));
    }

    _anypointAuthChanged(state) {
      if (state) {
        this._listenOauth();
      } else {
        this._unlistenOauth();
      }
    }

    _listenOauth() {
      this.addEventListener('anypoint-signin-aware-error', this._oauth2ErrorHandler);
      this.addEventListener('anypoint-signin-aware-signed-out', this._oauth2SignedOut);
      this.addEventListener('anypoint-signin-aware-success', this._oauth2SignedIn);
    }

    _unlistenOauth() {
      this.removeEventListener('anypoint-signin-aware-error', this._oauth2ErrorHandler);
      this.removeEventListener('anypoint-signin-aware-signed-out', this._oauth2SignedOut);
      this.removeEventListener('anypoint-signin-aware-success', this._oauth2SignedIn);
    }

    _oauth2ErrorHandler(e) {
      const message = e.detail.message;
      this.$.errorToast.text = message;
      this.$.errorToast.opened = true;
      if (!this.authInitialized) {
        this.authInitialized = true;
      }
    }
    /**
     * Handles `anypoint-signin-aware-signed-out` custom event.
     * Handled when the user is signed out.
     */
    _oauth2SignedOut() {
      if (!this.authInitialized) {
        this.authInitialized = true;
      }
      this.updateSearch();
    }
    /**
     * Handles `anypoint-signin-aware-success` - the success - Anypoint
     * sign in custom event. Updates search items for logged in user.
     */
    _oauth2SignedIn() {
      if (!this.authInitialized) {
        this.authInitialized = true;
      }
      this.updateSearch();
    }
    /**
     * Calls `_setupAuthHeaders()` function when token value change.
     *
     * @param {String|undefined} token
     * @param {String|undefined} old
     */
    _accessTokenChenged(token, old) {
      if (!old && !token) {
        return;
      }
      this._setupAuthHeaders(token);
    }
    /**
     * Sets up authorization headers on `iron-request` element if the token
     * is available or clears headers if not.
     *
     * @param {?String} token Oauth 2 token value for Anypoint.
     */
    _setupAuthHeaders(token) {
      const headers = {};
      if (token) {
        headers.authorization = 'Bearer ' + token;
      }
      this.$.query.headers = headers;
    }
    /**
     * Updates width of the grid items when number of columens change
     *
     * @param {Number} value Current value of `columens` propert.
     */
    _columnsChanged(value) {
      if (!value || typeof value !== 'number') {
        value = 4;
      }
      this.updateStyles({
        '--exchange-search-grid-item-computed-width': (100/value) + '%'
      });
    }
    /**
     * Fired when the user requested to process the item.
     * The `detail` object of the event contains item response from
     * Exchange API.
     *
     * Note, the event can be canceled.
     *
     * @event process-exchange-asset-data
     * @param {String} groupId
     * @param {String} assetId
     * @param {String} version
     * @param {String} versionGroup
     * @param {String} productAPIVersion
     * @param {Boolean} isPublic
     * @param {String} name
     * @param {String} type
     * @param {String} status
     * @param {String} assetLink
     * @param {String} createdAt
     * @param {String} runtimeVersion
     * @param {Number} rating
     * @param {Number} numberOfRates
     * @param {String} id
     * @param {String} icon
     * @param {String} modifiedAt
     * @param {Object} organization
     * @param {Object} createdBy
     * @param {Array} tags
     * @param {Array} files
     */
    /**
     * Dispatched when the element or user request access token from the Exchange
     * server.
     *
     * @event oauth2-token-requested
     * @param {String} state
     * @param {String} clientId
     * @param {String} redirectUrl
     * @param {String} type Always `implicit`
     * @param {String} authorizationUrl
     * @param {String} interactive After loading the element it tries the
     * non-interactive method of authorization. When auth button is clicked
     * then this value is always `true`.
     */
  }
  window.customElements.define(ExchangeSearchPanel.is, ExchangeSearchPanel);
  </script>
</dom-module>
